<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“Š ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ  â†’ ç®±ã²ã’å›³ã‚¯ã‚¤ã‚º (ä¸€ç”»é¢åå®¹ç‰ˆ)</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    text-align: center;
    margin: 20px;
    background-color: #f8f9fa;
    transition: background-color 0.6s ease;
  }
  h1 { font-size: 1.6em; margin-bottom: 10px; }
  p { font-size: 0.95em; color: #333; }
  
  /* --- ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ --- */
  #gameContainer {
    display: block; 
  }

  /* --- ãƒ¡ã‚¤ãƒ³ã®å•é¡Œã‚°ãƒ©ãƒ• (é«˜ã•ä¿®æ­£) --- */
  #mainChart {
    margin: 10px auto; /* ãƒãƒ¼ã‚¸ãƒ³ã‚‚å°‘ã—ç¸®å° */
    width: 95%;
    max-width: 600px;
    height: 250px; 
  }
  
  /* --- é¸æŠè‚¢ (CSS Grid) --- */
  #options {
    display: grid;
    grid-template-columns: repeat(2, 1fr); 
    gap: 10px;
    width: 95%;
    max-width: 650px; 
    margin: 10px auto;
  }
  @media (max-width: 600px) {
    #options {
        grid-template-columns: repeat(2, 1fr); 
        max-width: 95%;
    }
  }

  /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¨ã‚°ãƒ©ãƒ•ã‚’ã¾ã¨ã‚ãŸãƒ©ãƒ™ãƒ«å…¨ä½“ */
  .option-label {
    display: block; 
    border: 3px solid #ccc;
    padding: 8px;
    border-radius: 10px;
    transition: 0.25s;
    background-color: white;
    cursor: pointer; 
  }
  .option-label:hover { border-color: #007BFF; transform: scale(1.02); }
  
  /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .radio-container {
    text-align: left;
    margin-bottom: 5px;
    font-weight: bold;
    color: #007BFF;
  }
  /* é¸æŠè‚¢ã®ã‚°ãƒ©ãƒ•ã®é«˜ã•ä¿®æ­£ */
  .option-plot {
    width: 100%;
    height: 100px; 
  }

  /* --- çŠ¶æ…‹å¤‰åŒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
  .correct { border-color: #00c853 !important; background-color: #eaffea; }
  .wrong { border-color: #ff1744 !important; background-color: #ffeaea; }
  .disabled { pointer-events: none; opacity: 1; } 
  
  /* é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã«åˆã‚ã›ãŸæ ç·š */
  input[type="radio"]:checked + .option-box {
      border-color: orange;
      box-shadow: 0 0 5px rgba(255, 165, 0, 0.5);
  }

  /* --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»ã‚¹ã‚³ã‚¢ --- */
  #message { font-size: 1.2em; margin-top: 10px; min-height: 1.5em; }
  #scoreboard { margin-top: 10px; font-size: 1em; color: #333; }
  #life { font-size: 1.4em; color: red; margin-top: 5px; }

  /* --- ãƒœã‚¿ãƒ³ --- */
  #gameover {
    display: none;
    margin-top: 30px;
    font-size: 1.2em;
    color: red;
    font-weight: bold;
  }
  
  /* ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ: ç­”ãˆåˆã‚ã›ã¨æ¬¡ã®å•é¡Œã‚’æ¨ªä¸¦ã³ã«é…ç½® */
  #buttonContainer {
    display: flex;
    justify-content: center; /* ä¸­å¤®å¯„ã› */
    gap: 15px; /* ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
    margin-top: 10px; 
    margin-bottom: 10px; 
  }
  
  button {
    font-size: 1em;
    padding: 10px 20px;
    margin-top: 0; 
    cursor: pointer;
    border: none;
    border-radius: 6px;
    flex-grow: 1; 
    max-width: 250px;
  }
  button:hover { background-color: #0056b3; }

  /* ç­”ãˆåˆã‚ã›ãƒœã‚¿ãƒ³ */
  #checkButton {
      background-color: #ff8c00; 
  }
  #checkButton:hover {
      background-color: #cc7000;
  }
  
  /* æ¬¡ã®å•é¡Œã¸ãƒœã‚¿ãƒ³ */
  #nextButton {
      background-color: #007BFF;
  }
  
</style>
</head>
<body onload="startGame()">

<div id="gameContainer">
  <h1 id="gameTitle">ğŸ“Š ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ  â†’ ç®±ã²ã’å›³ã‚¯ã‚¤ã‚º</h1>
  <p id="gameInstructions">ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã‚’è¦‹ã¦ã€å¯¾å¿œã™ã‚‹ç®±ã²ã’å›³ã‚’é¸ã¼ã†ï¼<br>
  3å›é–“é•ãˆã‚‹ã¨ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼5å•ã”ã¨ã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ğŸ”¥</p>

  <div id="life"></div>

  <div id="mainChart"></div>

  
  <div id="options">
    <label class="option-label" for="radio0">
      <div class="radio-container"><input type="radio" id="radio0" name="answer" value="0"> é¸æŠè‚¢ 1</div>
      <div class="option-box" id="opt0"><div id="box0" class="option-plot"></div></div>
    </label>
    
    <label class="option-label" for="radio1">
      <div class="radio-container"><input type="radio" id="radio1" name="answer" value="1"> é¸æŠè‚¢ 2</div>
      <div class="option-box" id="opt1"><div id="box1" class="option-plot"></div></div>
    </label>
    
    <label class="option-label" for="radio2">
      <div class="radio-container"><input type="radio" id="radio2" name="answer" value="2"> é¸æŠè‚¢ 3</div>
      <div class="option-box" id="opt2"><div id="box2" class="option-plot"></div></div>
    </label>
    
    <label class="option-label" for="radio3">
      <div class="radio-container"><input type="radio" id="radio3" name="answer" value="3"> é¸æŠè‚¢ 4</div>
      <div class="option-box" id="opt3"><div id="box3" class="option-plot"></div></div>
    </label>
  </div>

  <div id="buttonContainer">
    <button id="checkButton" onclick="showAnswer()">âœ… ç­”ãˆåˆã‚ã›</button> 
    <button id="nextButton" onclick="drawQuestion()" style="display:none;">ğŸ” æ¬¡ã®å•é¡Œã¸</button>
  </div>

  <div id="message"></div>
  <div id="scoreboard"></div>
  <div id="gameover"></div>

  <button id="restartButton" onclick="restartGame()" style="display:none;">ğŸ” ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
</div>


<script>
// ===== å®šæ•° =====
const distWeights = { "æ­£è¦åˆ†å¸ƒ": 0.2, "å³ã«æ­ªã‚“ã åˆ†å¸ƒ": 0.3, "å·¦ã«æ­ªã‚“ã åˆ†å¸ƒ": 0.3, "äºŒå³°æ€§åˆ†å¸ƒ": 0.2 };
const distTypes = Object.keys(distWeights);
// ãƒ¬ãƒ™ãƒ«1:é’ã€ãƒ¬ãƒ™ãƒ«2:ç·‘ã€ãƒ¬ãƒ™ãƒ«3:èµ¤
const histColors = ["#1976D2", "#388E3C", "#D32F2F"]; 
const X_RANGE = [0, 100]; 
const X_TICK_VALUES = [0, 20, 40, 60, 80, 100];

// ===== ã‚²ãƒ¼ãƒ çŠ¶æ…‹å¤‰æ•° =====
let totalQuestions = 0, correctAnswers = 0, currentAnswer = 0;
let gameOver = false, lives = 3, waitingNext = false; 
let gameMode = 'hist-to-box'; 
let shuffledDistTypes = []; 

// ===== ã‚°ãƒ©ãƒ•ãƒ»ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ (å¤‰æ›´ãªã—) =====
function randn(mean = 0, std = 1) {
  let u = 1 - Math.random(), v = 1 - Math.random();
  return mean + std * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function generateData(type, difficulty) {
  const n = 200;
  let shiftRange, scaleRange;
  // é›£æ˜“åº¦ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã®åˆ†æ•£ã¨å¹³å‡ã®ãƒ–ãƒ¬å¹…ã‚’èª¿æ•´
  if (difficulty === 1) { shiftRange = 5; scaleRange = 5; }
  else if (difficulty === 2) { shiftRange = 10; scaleRange = 8; }
  else { shiftRange = 15; scaleRange = 10; }
  
  const baseShift = 50; 
  const shift = baseShift + (Math.random() - 0.5) * shiftRange;
  const scale = 5 + Math.random() * scaleRange;
  
  let data = [];
  if (type === "æ­£è¦åˆ†å¸ƒ") data = Array.from({ length: n }, () => randn(shift, scale));
  else if (type === "å³ã«æ­ªã‚“ã åˆ†å¸ƒ") data = Array.from({ length: n }, () => Math.abs(randn(0, 1)) * scale * 4 + shift - 10);
  else if (type === "å·¦ã«æ­ªã‚“ã åˆ†å¸ƒ") data = Array.from({ length: n }, () => -Math.abs(randn(0, 1)) * scale * 4 + shift + 10);
  else if (type === "äºŒå³°æ€§åˆ†å¸ƒ") {
    const a = Array.from({ length: n / 2 }, () => randn(shift - 15, scale * 0.8));
    const b = Array.from({ length: n / 2 }, () => randn(shift + 15, scale * 0.8));
    data = a.concat(b);
  }

  // ãƒ‡ãƒ¼ã‚¿ã‚’0ï½100ã®ç¯„å›²ã«ã‚¯ãƒªãƒƒãƒ—
  return data.map(val => Math.min(Math.max(val, X_RANGE[0]), X_RANGE[1]));
}

// ===== ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) =====
function getShuffledDistTypes(excludeType) {
  shuffledDistTypes = distTypes.filter(t => t !== excludeType);
  for (let i = shuffledDistTypes.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffledDistTypes[i], shuffledDistTypes[j]] = [shuffledDistTypes[j], shuffledDistTypes[i]];
  }
}

function chooseWeightedRandom() {
  const r = Math.random();
  let sum = 0;
  for (const [type, w] of Object.entries(distWeights)) {
    sum += w;
    if (r <= sum) return type;
  }
  return distTypes[0];
}

// 5å•ã”ã¨ã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—
function getDifficulty() {
  const levelIndex = Math.floor(totalQuestions / 5);
  return Math.min(levelIndex + 1, 3);
}

function setTheme(difficulty) {
  const colors = ["#e6f0ff", "#eaffea", "#fff0f0"];
  document.body.style.backgroundColor = colors[difficulty - 1];
}

function updateLifeDisplay() {
  document.getElementById("life").innerHTML = "â¤ï¸".repeat(lives) + "ğŸ¤".repeat(3 - lives);
}


function drawQuestion() {
  // --- 1. UIãƒªã‚»ãƒƒãƒˆ ---
  const radioButtons = document.querySelectorAll('input[name="answer"]');
  radioButtons.forEach(radio => radio.checked = false); 
  
  document.querySelectorAll('.option-label').forEach(label => {
    label.classList.remove("correct", "wrong", "disabled");
  });

  document.getElementById("message").innerText = "";
  document.getElementById("gameover").style.display = "none";
  document.getElementById("nextButton").style.display = "none";
  document.getElementById("restartButton").style.display = "none";
  document.getElementById("checkButton").disabled = false; 
  waitingNext = false;

  // --- 2. å•é¡Œè¨­å®š ---
  const difficulty = getDifficulty();
  setTheme(difficulty);

  const correctType = chooseWeightedRandom();
  currentAnswer = Math.floor(Math.random() * 4);
  
  const correctData = generateData(correctType, difficulty);

  // æ­£è§£ãƒ‡ãƒ¼ã‚¿ã®æœ€å°å€¤ã¨æœ€å¤§å€¤ã‚’å–å¾—
  const correctMin = Math.min(...correctData);
  const correctMax = Math.max(...correctData);

  // ä¸æ­£è§£ã®é¸æŠè‚¢ã‹ã‚‰ã€æœ€å¤§ãƒ»æœ€å°å€¤ãŒä¸€è‡´ã™ã‚‹ã€Œãƒ€ãƒŸãƒ¼ã€ã‚’é¸ã¶
  const wrongOptions = [0, 1, 2, 3].filter(i => i !== currentAnswer);
  const targetOptionIndex = wrongOptions[Math.floor(Math.random() * wrongOptions.length)];


  const mainChartType = 'histogram'; 
  const optionChartType = 'box'; 
  
  // é›£æ˜“åº¦ã«å¿œã˜ãŸãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã®è‰²ã‚’è¨­å®š
  const histColor = histColors[difficulty - 1]; 

  // --- 3. ãƒ¡ã‚¤ãƒ³ã‚°ãƒ©ãƒ•æç”» ---
  const mainTrace = {
    x: correctData,
    type: mainChartType,
    marker: { color: histColor }
  };

  const mainLayout = {
    title: `é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ« ${difficulty}`,
    margin: { t: 40, l: 40, r: 20, b: 30 }, 
    xaxis: { 
        range: X_RANGE,
        tickvals: X_TICK_VALUES // ãƒ¡ã‚¤ãƒ³ã‚°ãƒ©ãƒ•ã¯ç›®ç››ã‚’ä¿æŒ
    }, 
    yaxis: { title: 'åº¦æ•°' }
  };
  
  Plotly.newPlot("mainChart", [mainTrace], mainLayout, { staticPlot: true });

  getShuffledDistTypes(correctType);
  let wrongTypeIndex = 0;

  // --- 4. é¸æŠè‚¢ã‚°ãƒ©ãƒ•æç”» ---
  for (let i = 0; i < 4; i++) {
    let dataForOption, typeForOption;

    if (i === currentAnswer) {
      // æ­£è§£ã®é¸æŠè‚¢ã¯ãã®ã¾ã¾
      dataForOption = correctData;
      typeForOption = correctType;
    } else {
      // ä¸æ­£è§£ã®é¸æŠè‚¢ã®ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
      typeForOption = shuffledDistTypes[wrongTypeIndex % shuffledDistTypes.length];
      wrongTypeIndex++;
      dataForOption = generateData(typeForOption, difficulty);

      // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®é¸æŠè‚¢ã¯æœ€å°å€¤ã¨æœ€å¤§å€¤ã®ä¸¡æ–¹ã‚’å¼·åˆ¶çš„ã«ä¸€è‡´ã•ã›ã‚‹
      if (i === targetOptionIndex) {
          // ãƒ‡ãƒ¼ã‚¿ã‚’æ­£è§£ã®æœ€å°å€¤ã¨æœ€å¤§å€¤ã®é–“ã«ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°
          dataForOption = dataForOption.map(val => 
              Math.min(Math.max(val, correctMin), correctMax)
          );
          // æœ€å°å€¤ã¨æœ€å¤§å€¤ã‚’æ˜ç¤ºçš„ã«è¿½åŠ ã—ã€ã²ã’ã®ç«¯ã®ä¸€è‡´ã‚’ç¢ºå®Ÿã«ã™ã‚‹
          dataForOption.push(correctMin);
          dataForOption.push(correctMax);
      }
    }

    const optionTrace = {
      x: dataForOption,
      type: optionChartType,
      marker: { color: 'gray' },
      boxpoints: false 
    };
    
    // é¸æŠè‚¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
    const optionLayout = {
      margin: { t: 10, b: 10, l: 10, r: 10 }, 
      xaxis: { 
        range: X_RANGE, 
        // ç›®ç››ã¨è»¸ã‚’å®Œå…¨ã«éè¡¨ç¤ºã«ã™ã‚‹
        visible: false,
        showticklabels: false,
        showline: false,
        showgrid: false,
        zeroline: false
      }, 
      yaxis: { showticklabels: false } 
    };
    
    Plotly.newPlot(`box${i}`, [optionTrace], optionLayout, { staticPlot: true });
    
    document.getElementById(`box${i}`).dataset.distType = typeForOption;
  }
  
  document.getElementById("mainChart").dataset.correctType = correctType;
  updateLifeDisplay();
}

// ã€Œç­”ãˆåˆã‚ã›ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
function showAnswer() {
  if (gameOver || waitingNext) return;

  const selectedRadio = document.querySelector('input[name="answer"]:checked');

  // 1. é¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if (!selectedRadio) {
      document.getElementById("message").innerHTML = "âš ï¸ é¸æŠè‚¢ã‚’ä¸€ã¤é¸ã‚“ã§ãã ã•ã„ï¼";
      document.getElementById("message").style.color = "orange";
      return;
  }
  
  // ç­”ãˆåˆã‚ã›å®Ÿè¡Œ
  waitingNext = true; 
  document.getElementById("checkButton").disabled = true; 
  
  document.querySelectorAll('.option-label').forEach(label => label.classList.add("disabled"));

  const msg = document.getElementById("message");
  
  // æ¬¡ã®å•é¡Œã¸è¡Œãå‰ã«totalQuestionsã‚’å¢—ã‚„ã™
  totalQuestions++; 
  const userChoice = parseInt(selectedRadio.value);

  // 2. æ­£è§£/ä¸æ­£è§£ã‚’åˆ¤å®šã—ã€ã‚¹ã‚³ã‚¢ã¨ãƒ©ã‚¤ãƒ•ã‚’æ›´æ–°
  if (userChoice === currentAnswer) {
    correctAnswers++;
    msg.innerHTML = "ğŸ¯ æ­£è§£ï¼";
    msg.style.color = "green";
    document.getElementById(`opt${userChoice}`).closest('.option-label').classList.add("correct");
  } else {
    lives--;
    // ä¸æ­£è§£æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    msg.innerHTML = "âŒ é–“é•ã„ï¼ã‚‚ã†ä¸€åº¦ã€ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã¨ç®±ã²ã’å›³ã®å¯¾å¿œã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
    msg.style.color = "red";
    // æ­£è§£ã®é¸æŠè‚¢ã«æ ç·šã‚’è¡¨ç¤º
    // â˜… ä¿®æ­£ç‚¹: userAnswer -> userChoice ã«å¤‰æ›´ â˜…
    document.getElementById(`opt${userChoice}`).closest('.option-label').classList.add("wrong");
    document.getElementById(`opt${currentAnswer}`).closest('.option-label').classList.add("correct");
  }

  updateLifeDisplay();
  const rate = totalQuestions > 0 ? ((correctAnswers / totalQuestions) * 100).toFixed(1) : 0.0;
  document.getElementById("scoreboard").innerText = `æˆç¸¾ï¼š${correctAnswers} / ${totalQuestions}å•ã€€ï¼ˆæ­£ç­”ç‡ï¼š${rate}%ï¼‰`;
  
  // 3. ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
  if (lives <= 0) {
    gameOver = true;
    document.getElementById("restartButton").style.display = "inline-block";
    document.getElementById("gameover").style.display = "block";
    document.getElementById("gameover").innerText = `ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼ã‚ãªãŸã®æœ€çµ‚ã‚¹ã‚³ã‚¢ï¼š${correctAnswers}å•æ­£è§£ ğŸ¯`;
    document.body.style.backgroundColor = "#ffcccc";
    return;
  }

  // 4. æ¬¡ã®ãƒœã‚¿ãƒ³é¡ã‚’è¡¨ç¤º
  // â˜… ä¿®æ­£ç‚¹: é–“é•ãˆã¦ã‚‚ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§ãªã‘ã‚Œã°è¡¨ç¤ºã•ã‚Œã‚‹ â˜…
  document.getElementById("nextButton").style.display = "inline-block";
}


function restartGame() {
  totalQuestions = 0; correctAnswers = 0; lives = 3; gameOver = false;
  document.getElementById("scoreboard").innerText = "";
  document.getElementById("nextButton").style.display = "none";
  document.getElementById("restartButton").style.display = "none";
  drawQuestion();
}

function startGame() {
  restartGame();
}
</script>
</body>
</html>
